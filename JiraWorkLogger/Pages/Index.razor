@page "/"
@inject WorkLogService WorkLogService
@inject IConfiguration Configuration
@implements IDisposable

<PageTitle>Jira Work Logger</PageTitle>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h1>‚ö° Jira Work Logger</h1>
            <p style="color: #718096; margin: 0; font-size: 13px;">Sync your Scrinio time tracking with Jira worklogs</p>
        </div>
        <button class="btn-toggle" @onclick="ToggleConfig" title="@(configCollapsed ? "Expand" : "Collapse") configuration">
            @if (configCollapsed)
            {
                <text>‚ñº</text>
            }
            else
            {
                <text>‚ñ≤</text>
            }
        </button>
    </div>
    
    @if (!configCollapsed)
    {
        <h2>üîß Configuration</h2>
        <div class="form-group">
            <label for="scrinToken">
                Scrinio Token
                <a href="https://scrin.io/account" target="_blank" rel="noopener noreferrer" class="help-link" title="Get your Scrinio token">‚ÑπÔ∏è</a>
            </label>
            <input type="text" id="scrinToken" @bind="scrinToken" placeholder="Enter Scrinio token" />
        </div>
        
        <div class="form-group">
            <label for="jiraEmail">Jira Email</label>
            <input type="email" id="jiraEmail" @bind="jiraEmail" placeholder="Enter Jira email" />
        </div>
        
        <div class="form-group">
            <label for="jiraApiToken">
                Jira API Token
                <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank" rel="noopener noreferrer" class="help-link" title="Get your Jira API token">‚ÑπÔ∏è</a>
            </label>
            <input type="password" id="jiraApiToken" @bind="jiraApiToken" placeholder="Enter Jira API token" />
        </div>
        
        <div class="form-group">
            <label for="jiraBaseUrl">Jira Company URL</label>
            <input type="text" id="jiraBaseUrl" @bind="jiraBaseUrl" placeholder="https://yourcompany.atlassian.net" />
        </div>
    }
</div>

<div class="card">
    <h2>üìÖ Date Range</h2>
    <div class="quick-dates">
        <button type="button" class="quick-date-btn" @onclick="SetToday">Today</button>
        <button type="button" class="quick-date-btn" @onclick="SetYesterday">Yesterday</button>
        <button type="button" class="quick-date-btn" @onclick="SetThisWeek">This Week</button>
        <button type="button" class="quick-date-btn" @onclick="SetLastWeek">Last Week</button>
    </div>
    <div class="date-inputs">
        <div class="form-group">
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" @bind="startDate" />
        </div>
        <div class="form-group">
            <label for="endDate">End Date (leave empty for single date)</label>
            <input type="date" id="endDate" value="@(endDate?.ToString("yyyy-MM-dd") ?? "")" @onchange="OnEndDateChanged" />
        </div>
    </div>
    
    <div style="display: flex; align-items: center; gap: 12px;">
        <button class="btn btn-primary" @onclick="LoadPreview" disabled="@isLoading">
            @if (isLoading)
            {
                <span class="spinner"></span>
                <text>Loading...</text>
            }
            else
            {
                <text>üîç Load Preview</text>
            }
        </button>
        @if (isLoading)
        {
            <span class="loading-text">Fetching data from Scrinio...</span>
        }
    </div>
</div>

@if (previewItems != null && previewItems.Any())
{
    var totalHours = previewItems.Sum(p => p.Seconds) / 3600.0;
    var totalEntries = previewItems.Count;
    var uniqueTickets = previewItems.Select(p => p.Ticket).Distinct().Count();
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
                <h2>üìä Preview</h2>
                <p style="color: #718096; margin: -12px 0 0 0; font-size: 12px;">Review your time entries before logging to Jira</p>
            </div>
            <div class="preview-summary">
                <div class="summary-item">
                    <span class="summary-label">Total Hours</span>
                    <span class="summary-value">@totalHours.ToString("F2")</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Entries</span>
                    <span class="summary-value">@totalEntries</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Tickets</span>
                    <span class="summary-value">@uniqueTickets</span>
                </div>
            </div>
        </div>
        <table class="preview-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Ticket</th>
                    <th>Hours</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in previewItems.OrderBy(p => p.Date).ThenBy(p => p.Ticket))
                {
                    <tr>
                        <td>@item.Date.ToString("yyyy-MM-dd")</td>
                        <td><strong>@item.Ticket</strong></td>
                        <td class="hours-cell">@((item.Seconds / 3600.0).ToString("F2"))</td>
                    </tr>
                }
            </tbody>
        </table>
        
        <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <div class="preview-total">
                <strong>Total: @totalHours.ToString("F2") hours across @uniqueTickets ticket(s)</strong>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                @if (isLogging && previewItems != null)
                {
                    <div class="progress-info">
                        Logging @(logMessages.Count(m => m.Type == "success" || m.Type == "error")) of @previewItems.Count entries...
                    </div>
                }
                <button class="btn btn-success" @onclick="LogToJira" disabled="@(isLogging || isLoading)">
                    @if (isLogging)
                    {
                        <span class="spinner"></span>
                        <text>Logging...</text>
                    }
                    else
                    {
                        <text>‚úÖ Log Time to Jira</text>
                    }
                </button>
            </div>
        </div>
    </div>
}
else if (previewItems != null && !previewItems.Any())
{
    <div class="card">
        <div class="preview-empty">
            <div class="preview-empty-icon">üì≠</div>
            <p><strong>No time entries found</strong></p>
            <p class="preview-empty-hint">No activities with notes found for the selected date range. Make sure you have time entries with notes in Scrinio.</p>
        </div>
    </div>
}

<div class="card">
    <div class="log-header">
        <div>
            <h2>üìù Activity Log</h2>
            <p class="log-subtitle">Real-time updates from your sync operations</p>
        </div>
        <div class="log-header-actions">
            @if (logMessages.Any())
            {
                <div class="log-stats">
                    <span class="stat-badge stat-success">@logMessages.Count(m => m.Type == "success") ‚úì</span>
                    <span class="stat-badge stat-info">@logMessages.Count(m => m.Type == "info") ‚Ñπ</span>
                    <span class="stat-badge stat-error">@logMessages.Count(m => m.Type == "error") ‚úï</span>
                </div>
                <button class="btn-clear" @onclick="ClearLogs" title="Clear all log messages">
                    üóëÔ∏è Clear
                </button>
            }
        </div>
    </div>
    <div class="log-container" @ref="logContainerRef">
        @if (!logMessages.Any())
        {
            <div class="log-empty">
                <div class="log-empty-icon">üìã</div>
                <p>No log messages yet</p>
                <p class="log-empty-hint">Start a sync operation to see activity here</p>
            </div>
        }
        else
        {
            @foreach (var msg in logMessages)
            {
                <div class="log-message @msg.Type">
                    <div class="log-icon">
                        @if (msg.Type == "success")
                        {
                            <span>‚úì</span>
                        }
                        else if (msg.Type == "error")
                        {
                            <span>‚úï</span>
                        }
                        else
                        {
                            <span>‚Ñπ</span>
                        }
                    </div>
                    <div class="log-content">
                        <div class="log-text">@msg.Message</div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-error">
        <strong>‚ö†Ô∏è Error:</strong> @errorMessage
        <button class="alert-dismiss" @onclick="() => errorMessage = string.Empty" title="Dismiss">√ó</button>
    </div>
}

@if (showSuccessMessage)
{
    <div class="alert alert-success success-toast">
        <strong>‚úÖ Success!</strong> All time entries have been logged to Jira successfully.
        <button class="alert-dismiss" @onclick="DismissSuccess" title="Dismiss">√ó</button>
    </div>
}

@code {
    private string scrinToken = "";
    private string jiraEmail = "";
    private string jiraApiToken = "";
    private string jiraBaseUrl = "";
    private int timeZoneOffsetMinutes = 240;
    private DateTime startDate = DateTime.Today;
    private DateTime? endDate = null;
    
    private List<WorkLogService.PreviewItem>? previewItems = null;
    private bool isLoading = false;
    private bool isLogging = false;
    private string errorMessage = "";
    private bool showSuccessMessage = false;
    private bool configCollapsed = false;
    private List<WorkLogService.LogMessage> logMessages = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        try
        {
            // Optionally pre-populate from appsettings.json
            var scrinTokenConfig = Configuration["Scrin:Token"];
            var jiraEmailConfig = Configuration["Jira:Email"];
            var jiraApiTokenConfig = Configuration["Jira:ApiToken"];
            var jiraBaseUrlConfig = Configuration["Jira:BaseUrl"];
            var timeZoneOffsetConfig = Configuration["Settings:TimeZoneOffsetMinutes"];
            
            if (!string.IsNullOrWhiteSpace(scrinTokenConfig))
                scrinToken = scrinTokenConfig;
            if (!string.IsNullOrWhiteSpace(jiraEmailConfig))
                jiraEmail = jiraEmailConfig;
            if (!string.IsNullOrWhiteSpace(jiraApiTokenConfig))
                jiraApiToken = jiraApiTokenConfig;
            if (!string.IsNullOrWhiteSpace(jiraBaseUrlConfig))
                jiraBaseUrl = jiraBaseUrlConfig;
            if (!string.IsNullOrWhiteSpace(timeZoneOffsetConfig) && int.TryParse(timeZoneOffsetConfig, out var offset))
                timeZoneOffsetMinutes = offset;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error initializing: {ex.Message}";
        }
    }


    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                WorkLogService.OnLogMessage += HandleLogMessage;
            }
            catch (Exception ex)
            {
                errorMessage = $"Error setting up log handler: {ex.Message}";
            }
        }
    }

    private ElementReference logContainerRef;

    private void HandleLogMessage(WorkLogService.LogMessage message)
    {
        try
        {
            logMessages.Add(message);
            _ = InvokeAsync(async () =>
            {
                StateHasChanged();
                await ScrollToBottom();
            });
        }
        catch
        {
            // Ignore errors in event handler
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await Task.Delay(100); // Small delay to ensure DOM is updated
            // Auto-scroll happens naturally as container grows
        }
        catch
        {
            // Ignore errors
        }
    }

    private void ClearLogs()
    {
        logMessages.Clear();
        StateHasChanged();
    }

    private void SetToday()
    {
        startDate = DateTime.Today;
        endDate = null;
        StateHasChanged();
    }

    private void SetYesterday()
    {
        startDate = DateTime.Today.AddDays(-1);
        endDate = null;
        StateHasChanged();
    }

    private void SetThisWeek()
    {
        var today = DateTime.Today;
        var daysUntilMonday = ((int)today.DayOfWeek - (int)DayOfWeek.Monday + 7) % 7;
        startDate = today.AddDays(-daysUntilMonday);
        endDate = today;
        StateHasChanged();
    }

    private void SetLastWeek()
    {
        var today = DateTime.Today;
        var daysUntilMonday = ((int)today.DayOfWeek - (int)DayOfWeek.Monday + 7) % 7;
        var lastMonday = today.AddDays(-daysUntilMonday - 7);
        var lastSunday = lastMonday.AddDays(6);
        startDate = lastMonday;
        endDate = lastSunday;
        StateHasChanged();
    }

    private void DismissSuccess()
    {
        showSuccessMessage = false;
        StateHasChanged();
    }

    private void ToggleConfig()
    {
        configCollapsed = !configCollapsed;
        StateHasChanged();
    }

    public void Dispose()
    {
        try
        {
            WorkLogService.OnLogMessage -= HandleLogMessage;
        }
        catch
        {
            // Ignore errors during disposal
        }
    }

    private void OnEndDateChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            endDate = null;
        }
        else if (DateTime.TryParse(value, out var date))
        {
            endDate = date;
        }
    }

    private async Task LoadPreview()
    {
        var missingFields = new List<string>();
        if (string.IsNullOrWhiteSpace(scrinToken)) missingFields.Add("Scrinio Token");
        if (string.IsNullOrWhiteSpace(jiraEmail)) missingFields.Add("Jira Email");
        if (string.IsNullOrWhiteSpace(jiraApiToken)) missingFields.Add("Jira API Token");
        if (string.IsNullOrWhiteSpace(jiraBaseUrl)) missingFields.Add("Jira Company URL");
        
        if (missingFields.Any())
        {
            errorMessage = $"Please fill in the following fields: {string.Join(", ", missingFields)}";
            return;
        }

        isLoading = true;
        errorMessage = "";
        logMessages.Clear();
        previewItems = null;
        StateHasChanged();

        try
        {
            var end = endDate ?? startDate;
            previewItems = await WorkLogService.GetPreview(
                scrinToken,
                jiraEmail,
                jiraApiToken,
                jiraBaseUrl,
                timeZoneOffsetMinutes,
                startDate,
                end
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading preview: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LogToJira()
    {
        if (previewItems == null || !previewItems.Any())
        {
            errorMessage = "No preview items to log.";
            return;
        }

        isLogging = true;
        errorMessage = "";
        logMessages.Clear();
        StateHasChanged();

        try
        {
            await WorkLogService.LogToJira(
                previewItems,
                jiraEmail,
                jiraApiToken,
                jiraBaseUrl,
                timeZoneOffsetMinutes
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"Error logging to Jira: {ex.Message}";
        }
        finally
        {
            isLogging = false;
            
            // Show success message if all entries were logged successfully
            if (previewItems != null && logMessages.Any(m => m.Type == "success") && 
                !logMessages.Any(m => m.Type == "error" && m.Message.Contains("Failed")))
            {
                showSuccessMessage = true;
                // Auto-dismiss after 5 seconds
                _ = Task.Delay(5000).ContinueWith(_ => 
                {
                    showSuccessMessage = false;
                    InvokeAsync(StateHasChanged);
                });
            }
            
            StateHasChanged();
        }
    }
}

